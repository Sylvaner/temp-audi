<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Places Editor - Open Audio Guide</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      body {
        background-color: #f0f0f0;
      }
      #map {
        height: 400px;
        width: 100%;
        cursor: crosshair;
      }
      .box {
        background-color: #fafafa;
      }
      .place-card {
        margin-bottom: 1rem;
      }
      .language-tabs {
        margin-bottom: 1rem;
      }
      .places-list {
        max-height: 600px;
        overflow-y: auto;
        border-left: 1px solid #dbdbdb;
        padding-left: 1rem;
      }
      .place-item {
        cursor: pointer;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border: 1px solid #dbdbdb;
      }
      .place-item:hover {
        background-color: #f5f5f5;
      }
      .place-item.is-active {
        background-color: #f5f5f5;
        color: #363636;
        border-color: #00d1b2;
        border-width: 2px;
      }
      .place-item.is-active .has-text-grey {
        color: #4a4a4a !important;
      }
      .header-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .tab.is-incomplete {
        opacity: 0.6;
      }
      .tab.is-incomplete a {
        color: #ff3860 !important;
      }
      .language-tags {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
      }
      .user-location-icon {
        background: none !important;
        border: none !important;
      }
      .custom-marker {
        background: transparent !important;
        border: none !important;
      }
      .marker-preview {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background-color: #f5f5f5;
        border: 1px solid #dbdbdb;
      }
      .marker-icon-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      /* Styles pour les boutons de réorganisation */
      .place-item .buttons.has-addons {
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .place-item:hover .buttons.has-addons {
        opacity: 1;
      }

      .place-item .button.is-small {
        font-size: 0.6rem;
        padding: 0.2rem 0.3rem;
        height: auto;
        border-color: #dbdbdb;
        background-color: white;
        color: #363636;
      }

      .place-item .button.is-small:hover:not(:disabled) {
        background-color: #f5f5f5;
        border-color: #b5b5b5;
        color: #000;
      }

      .place-item .button.is-small:disabled {
        opacity: 0.3;
      }

      /* Améliorer la largeur des inputs de couleur */
      input[type='color'] {
        min-width: 60px;
        width: 60px;
        height: 2.5em;
        padding: 0;
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <section class="section">
        <div class="container is-fluid">
          <!-- Header -->
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <h1 class="title">Places Editor - Open Audio Guide</h1>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <div class="header-actions">
                  <input
                    type="file"
                    @change="loadFile"
                    accept=".json"
                    class="file-input"
                    id="file-input"
                    style="display: none"
                  />
                  <button @click="triggerFileInput" class="button is-primary">
                    <span class="icon"><i class="fas fa-upload"></i></span>
                    <span>Load</span>
                  </button>
                  <button @click="saveFile" class="button is-success" :disabled="!data.places">
                    <span class="icon"><i class="fas fa-download"></i></span>
                    <span>Save</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="columns">
            <!-- Main content -->
            <div class="column is-two-thirds">
              <!-- Map -->
              <div class="box">
                <h2 class="subtitle">Map - Click to add a place</h2>
                <div id="map"></div>
              </div>

              <!-- Place editor -->
              <div
                class="box"
                v-if="selectedPlaceIndex !== null && data.places[selectedPlaceIndex]"
              >
                <div class="level">
                  <div class="level-left">
                    <div class="level-item">
                      <h2 class="subtitle">Edit Place: {{ data.places[selectedPlaceIndex].id }}</h2>
                    </div>
                    <div
                      class="level-item"
                      v-if="data.places[selectedPlaceIndex].markerColor || data.places[selectedPlaceIndex].markerIcon"
                    >
                      <div class="marker-preview">
                        <div
                          class="marker-icon-preview"
                          :style="{ backgroundColor: data.places[selectedPlaceIndex].markerColor || '#B87333' }"
                        >
                          <i
                            class="fas"
                            :class="data.places[selectedPlaceIndex].markerIcon || 'fa-map-marker-alt'"
                            style="color: white; font-size: 10px"
                          ></i>
                        </div>
                        <span class="is-size-7">Preview</span>
                      </div>
                    </div>
                  </div>
                  <div class="level-right">
                    <div class="level-item">
                      <div class="field is-grouped">
                        <div class="control">
                          <button
                            @click="selectPlace(selectedPlaceIndex, true)"
                            class="button is-info is-small"
                            title="Center map on this place"
                          >
                            <span class="icon"><i class="fas fa-crosshairs"></i></span>
                            <span>Center</span>
                          </button>
                        </div>
                        <div class="control">
                          <button
                            @click="removePlace(selectedPlaceIndex)"
                            class="button is-danger is-small"
                          >
                            <span class="icon"><i class="fas fa-trash"></i></span>
                            <span>Delete</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="field is-grouped">
                  <div class="control is-expanded">
                    <label class="label">ID</label>
                    <input
                      v-model="data.places[selectedPlaceIndex].id"
                      class="input"
                      type="text"
                      placeholder="Unique ID"
                    />
                  </div>
                  <div class="control">
                    <label class="label">Coordinates</label>
                    <div class="field has-addons">
                      <div class="control">
                        <input
                          v-model.number="data.places[selectedPlaceIndex].latitude"
                          @change="updateMarker(selectedPlaceIndex)"
                          class="input"
                          type="number"
                          step="any"
                          placeholder="Latitude"
                        />
                      </div>
                      <div class="control">
                        <input
                          v-model.number="data.places[selectedPlaceIndex].longitude"
                          @change="updateMarker(selectedPlaceIndex)"
                          class="input"
                          type="number"
                          step="any"
                          placeholder="Longitude"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="field">
                  <label class="label">Image File (Common to all languages)</label>
                  <input
                    v-model="data.places[selectedPlaceIndex].imageFile"
                    class="input"
                    type="text"
                    placeholder="image-001.jpg"
                  />
                  <p class="help">Name of the image file (e.g., image-001.jpg, image-001.png)</p>
                </div>

                <!-- Marker customization -->
                <div class="field is-grouped">
                  <div class="control is-expanded">
                    <label class="label">Marker Color</label>
                    <div class="field has-addons">
                      <div class="control">
                        <input
                          v-model="data.places[selectedPlaceIndex].markerColor"
                          @change="updateMarker(selectedPlaceIndex)"
                          class="input"
                          type="color"
                          :value="data.places[selectedPlaceIndex].markerColor || '#B87333'"
                        />
                      </div>
                      <div class="control is-expanded">
                        <input
                          v-model="data.places[selectedPlaceIndex].markerColor"
                          @change="updateMarker(selectedPlaceIndex)"
                          class="input"
                          type="text"
                          placeholder="#B87333 or rgb(184, 115, 51)"
                        />
                      </div>
                    </div>
                    <p class="help">Custom color for the marker (CSS color value)</p>
                  </div>
                  <div class="control">
                    <label class="label">Marker Icon</label>
                    <input
                      v-model="data.places[selectedPlaceIndex].markerIcon"
                      @change="updateMarker(selectedPlaceIndex)"
                      class="input"
                      type="text"
                      placeholder="fa-monument"
                    />
                    <p class="help">FontAwesome icon class (without 'fas ')</p>
                  </div>
                </div>

                <!-- Predefined colors and icons -->
                <div class="field">
                  <label class="label">Quick Presets</label>
                  <div class="buttons are-small">
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '#8B4513', 'fa-monument')"
                      title="Monuments"
                    >
                      <span class="icon">
                        <div
                          class="marker-icon-preview"
                          style="background-color: #8b4513; width: 16px; height: 16px"
                        >
                          <i class="fas fa-monument" style="color: white; font-size: 8px"></i>
                        </div>
                      </span>
                      <span>Monument</span>
                    </button>
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '#32CD32', 'fa-seedling')"
                      title="Gardens"
                    >
                      <span class="icon">
                        <div
                          class="marker-icon-preview"
                          style="background-color: #32cd32; width: 16px; height: 16px"
                        >
                          <i class="fas fa-seedling" style="color: white; font-size: 8px"></i>
                        </div>
                      </span>
                      <span>Garden</span>
                    </button>
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '#2E8B57', 'fa-user-graduate')"
                      title="Education"
                    >
                      <span class="icon">
                        <div
                          class="marker-icon-preview"
                          style="background-color: #2e8b57; width: 16px; height: 16px"
                        >
                          <i class="fas fa-user-graduate" style="color: white; font-size: 8px"></i>
                        </div>
                      </span>
                      <span>Education</span>
                    </button>
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '#4169E1', 'fa-binoculars')"
                      title="Viewpoints"
                    >
                      <span class="icon">
                        <div
                          class="marker-icon-preview"
                          style="background-color: #4169e1; width: 16px; height: 16px"
                        >
                          <i class="fas fa-binoculars" style="color: white; font-size: 8px"></i>
                        </div>
                      </span>
                      <span>View</span>
                    </button>
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '#DC143C', 'fa-building')"
                      title="Buildings"
                    >
                      <span class="icon">
                        <div
                          class="marker-icon-preview"
                          style="background-color: #dc143c; width: 16px; height: 16px"
                        >
                          <i class="fas fa-building" style="color: white; font-size: 8px"></i>
                        </div>
                      </span>
                      <span>Building</span>
                    </button>
                    <button
                      class="button"
                      @click="applyPreset(selectedPlaceIndex, '', '')"
                      title="Reset to default"
                    >
                      <span class="icon"><i class="fas fa-undo"></i></span>
                      <span>Reset</span>
                    </button>
                  </div>
                  <p class="help">Click on a preset to quickly apply color and icon combinations</p>
                </div>

                <!-- Language tabs -->
                <div class="tabs language-tabs">
                  <ul>
                    <li
                      v-for="lang in availableLanguages"
                      :key="lang"
                      :class="{ 
                                            'is-active': currentLanguage === lang,
                                            'is-incomplete': !isLanguageComplete(data.places[selectedPlaceIndex], lang)
                                        }"
                    >
                      <a @click="currentLanguage = lang">
                        {{ lang.toUpperCase() }}
                        <span
                          v-if="!isLanguageComplete(data.places[selectedPlaceIndex], lang)"
                          class="icon is-small"
                        >
                          <i class="fas fa-exclamation-triangle"></i>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a @click="showAddLanguage = !showAddLanguage">
                        <span class="icon"><i class="fas fa-plus"></i></span>
                      </a>
                    </li>
                  </ul>
                </div>

                <!-- Add language -->
                <div v-if="showAddLanguage" class="field has-addons">
                  <div class="control">
                    <input
                      v-model="newLanguage"
                      class="input"
                      type="text"
                      placeholder="Language code (e.g., en, es, de)"
                    />
                  </div>
                  <div class="control">
                    <button @click="addLanguage" class="button is-primary">Add Language</button>
                  </div>
                </div>

                <!-- Current language content -->
                <div v-if="data.places[selectedPlaceIndex].content[currentLanguage]">
                  <div class="field">
                    <label class="label">Title</label>
                    <input
                      v-model="data.places[selectedPlaceIndex].content[currentLanguage].title"
                      class="input"
                      type="text"
                    />
                  </div>

                  <div class="field">
                    <label class="label">Short Description</label>
                    <input
                      v-model="data.places[selectedPlaceIndex].content[currentLanguage].description"
                      class="input"
                      type="text"
                    />
                  </div>

                  <div class="field">
                    <label class="label">Full Text</label>
                    <textarea
                      v-model="data.places[selectedPlaceIndex].content[currentLanguage].text"
                      class="textarea"
                      rows="4"
                    ></textarea>
                  </div>

                  <div class="field">
                    <label class="label">Audio File</label>
                    <input
                      v-model="data.places[selectedPlaceIndex].content[currentLanguage].audioFile"
                      class="input"
                      type="text"
                      placeholder="audio-001.mp3"
                    />
                    <p class="help">Name of the audio file (e.g., audio-001.mp3)</p>
                  </div>
                </div>
              </div>

              <!-- No place selected -->
              <div v-else class="box">
                <div class="content has-text-centered">
                  <p>Select a place from the list or click on the map to add a new one.</p>
                </div>
              </div>
            </div>

            <!-- Places list sidebar -->
            <div class="column">
              <div class="box">
                <h3 class="subtitle">Places ({{ data.places.length }})</h3>
                <div class="places-list">
                  <div
                    v-for="(place, index) in data.places"
                    :key="place.id"
                    @click="selectPlace(index)"
                    :class="{ 'place-item': true, 'is-active': selectedPlaceIndex === index }"
                  >
                    <div class="level is-mobile" style="margin-bottom: 0.25rem">
                      <div class="level-left">
                        <div class="level-item">
                          <div class="has-text-weight-bold">{{ place.id }}</div>
                        </div>
                      </div>
                      <div class="level-right">
                        <div class="level-item" v-if="place.markerColor || place.markerIcon">
                          <div
                            class="marker-icon-preview"
                            :style="{ backgroundColor: place.markerColor || '#B87333' }"
                            style="width: 16px; height: 16px"
                          >
                            <i
                              class="fas"
                              :class="place.markerIcon || 'fa-map-marker-alt'"
                              style="color: white; font-size: 8px"
                            ></i>
                          </div>
                        </div>
                        <div class="level-item">
                          <div class="buttons has-addons are-small">
                            <button
                              class="button is-small is-outlined"
                              :disabled="index === 0"
                              @click.stop="movePlaceUp(index)"
                              title="Déplacer vers le haut"
                            >
                              <span class="icon is-small">
                                <i class="fas fa-chevron-up"></i>
                              </span>
                            </button>
                            <button
                              class="button is-small is-outlined"
                              :disabled="index === data.places.length - 1"
                              @click.stop="movePlaceDown(index)"
                              title="Déplacer vers le bas"
                            >
                              <span class="icon is-small">
                                <i class="fas fa-chevron-down"></i>
                              </span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      class="is-size-7 has-text-grey"
                      v-if="place.content[currentLanguage]?.description"
                    >
                      {{ place.content[currentLanguage].description }}
                    </div>
                    <div class="is-size-7 has-text-grey">
                      {{ place.latitude.toFixed(4) }}, {{ place.longitude.toFixed(4) }}
                    </div>
                    <div class="is-size-7 language-tags">
                      <span
                        v-for="lang in availableLanguages"
                        :key="lang"
                        :class="{ 'tag': true, 'is-small': true, 'is-success': isLanguageComplete(place, lang), 'is-danger': !isLanguageComplete(place, lang) }"
                      >
                        {{ lang.toUpperCase() }}
                      </span>
                    </div>
                  </div>
                  <div v-if="data.places.length === 0" class="has-text-centered has-text-grey">
                    No places yet. Load a file or add one!
                  </div>
                </div>
              </div>

              <!-- Map Configuration -->
              <div class="box">
                <h3 class="subtitle">Configuration</h3>
                <div class="columns is-multiline">
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Default Language</label>
                      <div class="control">
                        <div class="select is-fullwidth">
                          <select v-model="data.config.defaultLanguage">
                            <option v-for="lang in availableLanguages" :key="lang" :value="lang">
                              {{ lang.toUpperCase() }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <p class="help">Language used when loading the application</p>
                    </div>
                  </div>
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Initial Zoom</label>
                      <input
                        v-model.number="data.config.map.zoom"
                        class="input"
                        type="number"
                        min="1"
                        max="18"
                      />
                      <p class="help">Default zoom level for the map</p>
                    </div>
                  </div>
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Initial Latitude</label>
                      <input
                        v-model.number="data.config.map.center.latitude"
                        class="input"
                        type="number"
                        step="any"
                      />
                    </div>
                  </div>
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Initial Longitude</label>
                      <input
                        v-model.number="data.config.map.center.longitude"
                        class="input"
                        type="number"
                        step="any"
                      />
                    </div>
                  </div>

                  <!-- Default Markers Configuration -->
                  <div class="column is-full">
                    <hr />
                    <h4 class="subtitle is-6">Default Markers Settings</h4>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Default Marker Color</label>
                      <div class="field has-addons">
                        <div class="control">
                          <input
                            v-model="data.config.markers.defaultColor"
                            class="input"
                            type="color"
                            :value="data.config.markers.defaultColor || '#B87333'"
                          />
                        </div>
                        <div class="control is-expanded">
                          <input
                            v-model="data.config.markers.defaultColor"
                            class="input"
                            type="text"
                            placeholder="#B87333"
                          />
                        </div>
                      </div>
                      <p class="help">Default color for new markers</p>
                    </div>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Place Icon</label>
                      <div class="control has-icons-left">
                        <input
                          v-model="data.config.markers.place"
                          class="input"
                          type="text"
                          placeholder="fa-monument"
                        />
                        <div class="icon is-small is-left">
                          <i class="fas" :class="data.config.markers?.place || 'fa-monument'"></i>
                        </div>
                      </div>
                      <p class="help">Icon for place markers (FontAwesome class)</p>
                    </div>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">User Location Icon</label>
                      <div class="control has-icons-left">
                        <input
                          v-model="data.config.markers.userLocation"
                          class="input"
                          type="text"
                          placeholder="fa-person-walking"
                        />
                        <div class="icon is-small is-left">
                          <i
                            class="fas"
                            :class="data.config.markers?.userLocation || 'fa-person-walking'"
                          ></i>
                        </div>
                      </div>
                      <p class="help">Icon for user location marker (FontAwesome class)</p>
                    </div>
                  </div>

                  <div class="column is-full" v-if="data.config.markers">
                    <div class="field">
                      <div class="marker-preview">
                        <div
                          class="marker-icon-preview"
                          :style="{ backgroundColor: data.config.markers.defaultColor || '#B87333' }"
                        >
                          <i
                            class="fas"
                            :class="data.config.markers?.place || 'fa-monument'"
                            style="color: white; font-size: 10px"
                          ></i>
                        </div>
                        <span class="is-size-7 has-text-grey">Default marker preview</span>
                      </div>
                    </div>
                  </div>

                  <!-- Go To Initial User Location Configuration -->
                  <div class="column is-full">
                    <hr />
                    <h4 class="subtitle is-6">Auto-Center on User Location</h4>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Enable Auto-Center</label>
                      <div class="control">
                        <label class="checkbox">
                          <input
                            type="checkbox"
                            v-model="data.config.goToInitialUserLocation.enable"
                          />
                          Center map on user if near initial center
                        </label>
                      </div>
                      <p class="help">
                        Automatically center the map on user location if they are within the
                        threshold distance from the initial center
                      </p>
                    </div>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Distance Threshold</label>
                      <input
                        v-model.number="data.config.goToInitialUserLocation.threshold"
                        class="input"
                        type="number"
                        step="0.001"
                        min="0.001"
                        max="1"
                      />
                      <p class="help">
                        Maximum distance (in degrees) from center to trigger auto-center
                      </p>
                    </div>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Zoom Increase</label>
                      <input
                        v-model.number="data.config.goToInitialUserLocation.increaseZoom"
                        class="input"
                        type="number"
                        min="0"
                        max="5"
                      />
                      <p class="help">How much to increase zoom when centering on user</p>
                    </div>
                  </div>

                  <div class="column is-half">
                    <div class="field">
                      <label class="label">Preview Threshold</label>
                      <div class="control">
                        <label class="checkbox">
                          <input
                            type="checkbox"
                            v-model="showThresholdPreview"
                            @change="toggleThresholdPreview"
                          />
                          Show threshold circle on map
                        </label>
                      </div>
                      <p class="help">Display a circle showing the auto-center threshold area</p>
                    </div>
                  </div>
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">&nbsp;</label>
                      <button @click="applyMapConfig" class="button is-primary is-fullwidth">
                        <span class="icon"><i class="fas fa-map-marked-alt"></i></span>
                        <span>Apply</span>
                      </button>
                    </div>
                  </div>
                  <div class="column is-half">
                    <div class="field">
                      <label class="label">&nbsp;</label>
                      <button @click="captureCurrentView" class="button is-info is-fullwidth">
                        <span class="icon"><i class="fas fa-crosshairs"></i></span>
                        <span>Current</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <input type="file" id="file-input" @change="loadFile" accept=".json" style="display: none" />
    <script src="app.js"></script>
  </body>
</html>
